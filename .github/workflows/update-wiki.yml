name: Update Wiki from Stars

on:
  workflow_dispatch: {}
  schedule:
    # 매일 00:00 (KST) = 15:00 UTC
    - cron: "0 15 * * *"

permissions:
  contents: write   # wiki push 포함을 위해 필요

env:
  TZ: Asia/Seoul
  STAR_TOKEN: ${{ secrets.STAR_TOKEN }}
  # 아래 환경변수는 선택 설정 (스크립트에서 사용)
  TITLE_STYLE: inline        # inline | newline
  NOTE_LABEL: "노트"
  NOTE_EMOJI: ""
  MEMO_PLACEHOLDER: ""       # 메모 없을 때 표시
  PRUNE_WIKI: "true"         # Home/카테고리/_Sidebar/notes 외 클린

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
      # 메인 레포(스크립트, config/* 등) 체크아웃
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps (fallback to ad-hoc)
        run: |
          set -e
          if [ -f package.json ]; then
            if command -v pnpm >/dev/null 2>&1; then
              pnpm i --frozen-lockfile || pnpm i
            else
              npm ci || npm i
            fi
          else
            # package.json이 없어도 동작하도록 최소 의존성 설치
            npm init -y
            npm i js-yaml @octokit/rest
          fi

      - name: Clone Wiki repo
        run: |
          set -e
          WIKI_URL="https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git"
          rm -rf wiki
          git clone "$WIKI_URL" wiki
          cd wiki
          # Wiki 기본 브랜치가 master인 경우가 많음
          git fetch origin
          git checkout master || git checkout main || git checkout -b master
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config --global --add safe.directory "$PWD"

      - name: Run update-wiki script
        # 앞서 드린 수정본 scripts/update-wiki.js 사용
        run: |
          node --version
          node scripts/update-wiki.js

      - name: Commit & Push changes to Wiki
        working-directory: wiki
        run: |
          set -e
          # 변경 여부 확인 후 커밋/푸시
          if ! git diff --quiet || ! git diff --cached --quiet; then
            git add -A
            git commit -m "ci: update wiki (pages + _Sidebar for categories only)"
            git push
          else
            echo "No wiki changes."
          fi
